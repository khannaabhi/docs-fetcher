
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chunk Visualization</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCI+PHRleHQgeD0iNTAiIHk9IjU1IiBmb250LXNpemU9IjkwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIj7wn6abPC90ZXh0Pjwvc3ZnPg==">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; line-height: 1.6; padding: 0; margin: 0; background-color: #F0F2F5; color: #333333; display: flex; flex-direction: column; min-height: 100vh; }
        .content-box { max-width: 900px; width: 100%; margin: 30px auto; padding: 30px 20px 20px 20px; background-color: #FFFFFF; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); box-sizing: border-box; }
        .text-display { white-space: pre-wrap; word-wrap: break-word; font-family: "Consolas", "Monaco", "Courier New", monospace; font-size: 0.95em; padding: 0; }
        .text-display span[style*="background-color"] { border-radius: 3px; padding: 0.1em 0; cursor: help; }
        .text-display br { display: block; content: ""; margin-top: 0.6em; }
        footer { text-align: center; margin-top: auto; padding: 15px 0; font-size: 0.8em; color: #888; border-top: 1px solid #eee; background-color: #f0f2f5; width: 100%; }
        footer a { color: #666; text-decoration: none; }
        footer a:hover { text-decoration: underline; }
        footer .heart { color: #d63384; display: inline-block; }
    </style>
</head>
<body>
    
<div class="content-box">
    <div class="text-display"><span style="background-color: #FFADAD;" title="Chunk 0 | Start: 0 | End: 1898 | Tokens: 1898"># Install Multiple Istio Control Planes in a Single Cluster<br><br>6 minute read [ page test](https://github.com/istio/istio.io/tree/master/README.md#testing-document-content &quot;An automated test is available for this page. Click for details.&quot;)<br><br>This guide walks you through the process of installing multiple Istio control planes within a single cluster and then a way to scope workloads to specific control planes. This deployment model has a single Kubernetes control plane with multiple Istio control planes and meshes. The separation between the meshes is provided by Kubernetes namespaces and RBAC.<br><br>[![Multiple meshes in a single cluster](/latest/docs/setup/install/multiple-controlplanes/single-cluster-multiple-istiods.svg)](/latest/docs/setup/install/multiple-controlplanes/single-cluster-multiple-istiods.svg &quot;Multiple meshes in a single cluster&quot;)<br><br>Multiple meshes in a single cluster<br><br>Using `discoverySelectors`, you can scope Kubernetes resources in a cluster to specific namespaces managed by an Istio control plane. This includes the Istio custom resources (e.g., Gateway, VirtualService, DestinationRule, etc.) used to configure the mesh. Furthermore, `discoverySelectors` can be used to configure which namespaces should include the `istio-ca-root-cert` config map for a particular Istio control plane. Together, these functions allow mesh operators to specify the namespaces for a given control plane, enabling soft multi-tenancy for multiple meshes based on the boundary of one or more namespaces. This guide uses `discoverySelectors`, along with the revisions capability of Istio, to demonstrate how two meshes can be deployed on a single cluster, each working with a properly scoped subset of the clusterâ€™s resources.<br><br>## Before you begin<br><br>This guide requires that you have a Kubernetes cluster with any of the [supported Kubernetes versions:](/latest/docs/releases/supported-releases/</span><span style="background-color: #FFD6A5;" title="Chunk 1 | Start: 1898 | End: 2277 | Tokens: 379">#support-status-of-istio-releases) 1.29, 1.30, 1.31, 1.32.<br><br>This cluster will host two control planes installed in two different system namespaces. The mesh application workloads will run in multiple application-specific namespaces, each namespace associated with one or the other control plane based on revision and discovery selector configurations.<br><br>## Cluster configuration<br><br></span><span style="background-color: #FDFFB6;" title="Chunk 2 | Start: 2277 | End: 4307 | Tokens: 2030">### Deploying multiple control planes<br><br>Deploying multiple Istio control planes on a single cluster can be achieved by using different system namespaces for each control plane. Istio revisions and `discoverySelectors` are then used to scope the resources and workloads that are managed by each control plane.<br><br>  1. Create the first system namespace, `usergroup-1`, and deploy istiod in it:<br>         <br>         $ kubectl create ns usergroup-1<br>         $ kubectl label ns usergroup-1 usergroup=usergroup-1<br>         $ istioctl install -y -f - &lt;&lt;EOF<br>         apiVersion: install.istio.io/v1alpha1<br>         kind: IstioOperator<br>         metadata:<br>           namespace: usergroup-1<br>         spec:<br>           profile: minimal<br>           revision: usergroup-1<br>           meshConfig:<br>             discoverySelectors:<br>               - matchLabels:<br>                   usergroup: usergroup-1<br>           values:<br>             global:<br>               istioNamespace: usergroup-1<br>         EOF<br><br>  2. Create the second system namespace, `usergroup-2`, and deploy istiod in it:<br>         <br>         $ kubectl create ns usergroup-2<br>         $ kubectl label ns usergroup-2 usergroup=usergroup-2<br>         $ istioctl install -y -f - &lt;&lt;EOF<br>         apiVersion: install.istio.io/v1alpha1<br>         kind: IstioOperator<br>         metadata:<br>           namespace: usergroup-2<br>         spec:<br>           profile: minimal<br>           revision: usergroup-2<br>           meshConfig:<br>             discoverySelectors:<br>               - matchLabels:<br>                   usergroup: usergroup-2<br>           values:<br>             global:<br>               istioNamespace: usergroup-2<br>         EOF<br><br>  3. Deploy a policy for workloads in the `usergroup-1` namespace to only accept mutual TLS traffic:<br>         <br>         $ kubectl apply -f - &lt;&lt;EOF<br>         apiVersion: security.istio.io/v1<br>         kind: PeerAuthentication<br>         metadata:<br>           name: &quot;usergroup-1-peerauth&quot;<br>           namespace: &quot;usergroup-1&quot;<br>         spec:<br>           mtls:<br>             mode: STRICT<br>         EOF<br><br></span><span style="background-color: #CAFFBF;" title="Chunk 3 | Start: 4307 | End: 4700 | Tokens: 393">  4. Deploy a policy for workloads in the `usergroup-2` namespace to only accept mutual TLS traffic:<br>         <br>         $ kubectl apply -f - &lt;&lt;EOF<br>         apiVersion: security.istio.io/v1<br>         kind: PeerAuthentication<br>         metadata:<br>           name: &quot;usergroup-2-peerauth&quot;<br>           namespace: &quot;usergroup-2&quot;<br>         spec:<br>           mtls:<br>             mode: STRICT<br>         EOF<br><br><br><br><br></span><span style="background-color: #9BF6FF;" title="Chunk 4 | Start: 4700 | End: 6578 | Tokens: 1878">### Verify the multiple control plane creation<br><br>  1. Check the labels on the system namespaces for each control plane:<br>         <br>         $ kubectl get ns usergroup-1 usergroup-2 --show-labels<br>         NAME              STATUS   AGE     LABELS<br>         usergroup-1       Active   13m     kubernetes.io/metadata.name=usergroup-1,usergroup=usergroup-1<br>         usergroup-2       Active   12m     kubernetes.io/metadata.name=usergroup-2,usergroup=usergroup-2<br><br>  2. Verify the control planes are deployed and running:<br>         <br>         $ kubectl get pods -n usergroup-1<br>         NAMESPACE     NAME                                     READY   STATUS    RESTARTS         AGE<br>         usergroup-1   istiod-usergroup-1-5ccc849b5f-wnqd6      1/1     Running   0                12m<br>         <br>         $ kubectl get pods -n usergroup-2<br>         NAMESPACE     NAME                                     READY   STATUS    RESTARTS         AGE<br>         usergroup-2   istiod-usergroup-2-658d6458f7-slpd9      1/1     Running   0                12m<br><br>You will notice that one istiod deployment per usergroup is created in the specified namespaces.<br><br>  3. Run the following commands to list the installed webhooks:<br>         <br>         $ kubectl get validatingwebhookconfiguration<br>         NAME                                      WEBHOOKS   AGE<br>         istio-validator-usergroup-1-usergroup-1   1          18m<br>         istio-validator-usergroup-2-usergroup-2   1          18m<br>         istiod-default-validator                  1          18m<br>         <br>         $ kubectl get mutatingwebhookconfiguration<br>         NAME                                             WEBHOOKS   AGE<br>         istio-revision-tag-default-usergroup-1           4          18m<br>         istio-sidecar-injector-usergroup-1-usergroup-1   2          19m<br>         istio-sidecar-injector-usergroup-2-usergroup-2   2          18m<br><br></span><span style="background-color: #A0C4FF;" title="Chunk 5 | Start: 6578 | End: 7036 | Tokens: 458">Note that the output includes `istiod-default-validator` and `istio-revision-tag-default-usergroup-1`, which are the default webhook configurations used for handling requests coming from resources which are not associated with any revision. In a fully scoped environment where every control plane is associated with its resources through proper namespace labeling, there is no need for these default webhook configurations. They should never be invoked.<br><br><br><br><br></span><span style="background-color: #BDB2FF;" title="Chunk 6 | Start: 7036 | End: 8935 | Tokens: 1899">### Deploy application workloads per usergroup<br><br>  1. Create three application namespaces:<br>         <br>         $ kubectl create ns app-ns-1<br>         $ kubectl create ns app-ns-2<br>         $ kubectl create ns app-ns-3<br><br>  2. Label each namespace to associate them with their respective control planes:<br>         <br>         $ kubectl label ns app-ns-1 usergroup=usergroup-1 istio.io/rev=usergroup-1<br>         $ kubectl label ns app-ns-2 usergroup=usergroup-2 istio.io/rev=usergroup-2<br>         $ kubectl label ns app-ns-3 usergroup=usergroup-2 istio.io/rev=usergroup-2<br><br>  3. Deploy one `curl` and `httpbin` application per namespace:<br>         <br>         $ kubectl -n app-ns-1 apply -f samples/curl/curl.yaml<br>         $ kubectl -n app-ns-1 apply -f samples/httpbin/httpbin.yaml<br>         $ kubectl -n app-ns-2 apply -f samples/curl/curl.yaml<br>         $ kubectl -n app-ns-2 apply -f samples/httpbin/httpbin.yaml<br>         $ kubectl -n app-ns-3 apply -f samples/curl/curl.yaml<br>         $ kubectl -n app-ns-3 apply -f samples/httpbin/httpbin.yaml<br><br>  4. Wait a few seconds for the `httpbin` and `curl` pods to be running with sidecars injected:<br>         <br>         $ kubectl get pods -n app-ns-1<br>         NAME                      READY   STATUS    RESTARTS   AGE<br>         httpbin-9dbd644c7-zc2v4   2/2     Running   0          115m<br>         curl-78ff5975c6-fml7c     2/2     Running   0          115m<br>         <br>         $ kubectl get pods -n app-ns-2<br>         NAME                      READY   STATUS    RESTARTS   AGE<br>         httpbin-9dbd644c7-sd9ln   2/2     Running   0          115m<br>         curl-78ff5975c6-sz728     2/2     Running   0          115m<br>         <br>         $ kubectl get pods -n app-ns-3<br>         NAME                      READY   STATUS    RESTARTS   AGE<br>         httpbin-9dbd644c7-8ll27   2/2     Running   0          115m<br>         curl-78ff5975c6-sg4tq     2/2     Running   0          115m<br><br><br><br><br></span><span style="background-color: #FFC6FF;" title="Chunk 7 | Start: 8935 | End: 10912 | Tokens: 1977">### Verify the application to control plane mapping<br><br>Now that the applications are deployed, you can use the `istioctl ps` command to confirm that the application workloads are managed by their respective control plane, i.e., `app-ns-1` is managed by `usergroup-1`, `app-ns-2` and `app-ns-3` are managed by `usergroup-2`:<br>    <br>    <br>    $ istioctl ps -i usergroup-1<br>    NAME                                 CLUSTER        CDS        LDS        EDS        RDS          ECDS         ISTIOD                                  VERSION<br>    httpbin-9dbd644c7-hccpf.app-ns-1     Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED       NOT SENT     istiod-usergroup-1-5ccc849b5f-wnqd6     1.17-alpha.f5212a6f7df61fd8156f3585154bed2f003c4117<br>    curl-78ff5975c6-9zb77.app-ns-1       Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED       NOT SENT     istiod-usergroup-1-5ccc849b5f-wnqd6     1.17-alpha.f5212a6f7df61fd8156f3585154bed2f003c4117<br>    <br>    <br>    $ istioctl ps -i usergroup-2<br>    NAME                                 CLUSTER        CDS        LDS        EDS        RDS          ECDS         ISTIOD                                  VERSION<br>    httpbin-9dbd644c7-vvcqj.app-ns-3     Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED       NOT SENT     istiod-usergroup-2-658d6458f7-slpd9     1.17-alpha.f5212a6f7df61fd8156f3585154bed2f003c4117<br>    httpbin-9dbd644c7-xzgfm.app-ns-2     Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED       NOT SENT     istiod-usergroup-2-658d6458f7-slpd9     1.17-alpha.f5212a6f7df61fd8156f3585154bed2f003c4117<br>    curl-78ff5975c6-fthmt.app-ns-2       Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED       NOT SENT     istiod-usergroup-2-658d6458f7-slpd9     1.17-alpha.f5212a6f7df61fd8156f3585154bed2f003c4117<br>    curl-78ff5975c6-nxtth.app-ns-3       Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED       NOT SENT     istiod-usergroup-2-658d6458f7-slpd9     1.17-alpha.f5212a6f7df61fd8156f3585154bed2f003c4117<br><br></span><span style="background-color: #FFADAD;" title="Chunk 8 | Start: 10912 | End: 12726 | Tokens: 1814">### Verify the application connectivity is ONLY within the respective usergroup<br><br>  1. Send a request from the `curl` pod in `app-ns-1` in `usergroup-1` to the `httpbin` service in `app-ns-2` in `usergroup-2`. The communication should fail:<br>         <br>         $ kubectl -n app-ns-1 exec &quot;$(kubectl -n app-ns-1 get pod -l app=curl -o jsonpath={.items..metadata.name})&quot; -c curl -- curl -sIL http://httpbin.app-ns-2.svc.cluster.local:8000<br>         HTTP/1.1 503 Service Unavailable<br>         content-length: 95<br>         content-type: text/plain<br>         date: Sat, 24 Dec 2022 06:54:54 GMT<br>         server: envoy<br><br>  2. Send a request from the `curl` pod in `app-ns-2` in `usergroup-2` to the `httpbin` service in `app-ns-3` in `usergroup-2`. The communication should work:<br>         <br>         $ kubectl -n app-ns-2 exec &quot;$(kubectl -n app-ns-2 get pod -l app=curl -o jsonpath={.items..metadata.name})&quot; -c curl -- curl -sIL http://httpbin.app-ns-3.svc.cluster.local:8000<br>         HTTP/1.1 200 OK<br>         server: envoy<br>         date: Thu, 22 Dec 2022 15:01:36 GMT<br>         content-type: text/html; charset=utf-8<br>         content-length: 9593<br>         access-control-allow-origin: *<br>         access-control-allow-credentials: true<br>         x-envoy-upstream-service-time: 3<br><br><br><br><br>## Cleanup<br><br>  1. Clean up the first usergroup:<br>         <br>         $ istioctl uninstall --revision usergroup-1 --set values.global.istioNamespace=usergroup-1<br>         $ kubectl delete ns app-ns-1 usergroup-1<br><br>  2. Clean up the second usergroup:<br>         <br>         $ istioctl uninstall --revision usergroup-2 --set values.global.istioNamespace=usergroup-2<br>         $ kubectl delete ns app-ns-2 app-ns-3 usergroup-2<br><br><br><br><br>Was this information useful?  <br>Yes No<br><br>Do you have any suggestions for improvement?  <br>  <br><br><br>Thanks for your feedback!<br><br>## Links<br><br><br><br></span></div>
</div>

    
<footer>
    Made with <span class="heart">ðŸ¤Ž</span> by <a href="https://github.com/chonkie-inc/chonkie" target="_blank" rel="noopener noreferrer">ðŸ¦› Chonkie</a>
</footer>

</body>
</html>
